<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flashcards â€“ Study & Revision</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f8f9fa; margin:0; padding: 20px }
    h1 { text-align: center; margin-bottom: 20px }
    .selectors {
      display: flex; flex-wrap: wrap; gap: 10px;
      justify-content: center; margin-bottom: 20px;
    }
    select, label {
      font-size: 16px; padding: 6px;
    }
    #contentArea, #cardsContainer {
      max-width: 800px; margin: 0 auto;
    }
    /* Revision cards */
    .question-card {
      background: #fff; border: 1px solid #ddd;
      border-radius: 8px; padding:15px; margin-bottom:10px;
    }
    .answer {
      background: #f9f9f9; padding:10px;
      border-left:4px solid #007bff; white-space: pre-wrap;
      margin-top:10px;
    }
    .btn-toggle {
      background: #007bff; color: #fff; border:none;
      padding:6px 12px; border-radius:4px; cursor:pointer;
      margin-top:10px;
    }
    .code-snippet {
      background: #f4f4f4; padding:10px; font-family:monospace;
      white-space:pre-wrap; border-left:4px solid #333;
      margin-top:10px;
    }
    /* Study iframe */
    #studyFrame {
      width: 100%; height: 80vh; border:1px solid #ccc;
      border-radius:8px; display: none;
    }
    #studyMsg {
      padding:20px; background:#fff;
      border:1px solid #ddd; border-radius:8px;
      text-align:center; display:none;
    }
  </style>
</head>
<body>

<h1>Flashcards</h1>

<div class="selectors">
  <label for="modeSelect">Mode:</label>
  <select id="modeSelect" onchange="handleModeChange()">
    <option value="study">Study</option>
    <option value="revision">Revision</option>
  </select>

  <label for="categorySelect">Category:</label>
  <select id="categorySelect" onchange="handleModeChange()">
    <option value="">-- Select Category --</option>
  </select>

  <label for="topicSelect">Topic:</label>
  <select id="topicSelect" onchange="handleModeChange()">
    <option value="">-- Select Topic --</option>
  </select>
</div>

<!-- Study Mode -->
<div id="contentArea">
  <iframe id="studyFrame" sandbox="allow-same-origin allow-scripts"></iframe>
  <div id="studyMsg">Please select both Category and Topic in Study mode.</div>
</div>

<!-- Revision Mode -->
<div id="cardsContainer"></div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    initSelectors().then(handleModeChange);
  });

  // 1) Populate Category & Topic from /api/flashcards/meta
  async function initSelectors() {
    try {
      const res = await fetch('/api/flashcards/meta');
      const { categories, topics } = await res.json();
      const catSel = document.getElementById('categorySelect');
      const topSel = document.getElementById('topicSelect');
      categories.forEach(c => catSel.add(new Option(c, c)));
      topics   .forEach(t => topSel.add(new Option(t, t)));
    } catch (err) {
      console.error('Failed to load metadata', err);
    }
  }

  // 2) Handle Mode / Category / Topic changes
  async function handleModeChange() {
    const mode     = document.getElementById('modeSelect').value;
    const category = document.getElementById('categorySelect').value;
    const topic    = document.getElementById('topicSelect').value;
    const iframe   = document.getElementById('studyFrame');
    const studyMsg = document.getElementById('studyMsg');
    const cardsDiv = document.getElementById('cardsContainer');

    if (mode === 'study') {
      // show study, hide revision
      cardsDiv.style.display   = 'none';
      iframe.style.display     = 'none';
      studyMsg.style.display   = 'none';

      if (category && topic) {
        const filename = `/${category}-${topic}.html`;
        iframe.src = filename;
        iframe.style.display = 'block';
      } else {
        studyMsg.textContent = 'Please select both Category and Topic in Study mode.';
        studyMsg.style.display = 'block';
      }

    } else {
      // show revision, hide study
      iframe.src = 'about:blank';
      iframe.style.display = 'none';
      studyMsg.style.display = 'none';
      cardsDiv.style.display = 'block';
      await loadRevision(category, topic);
    }
  }

  // 3) Fetch & render revision cards
  async function loadRevision(category, topic) {
    const cardsDiv = document.getElementById('cardsContainer');
    cardsDiv.innerHTML = '';
    try {
      const q = new URLSearchParams({ category, topic });
      const res = await fetch(`/api/flashcards?${q}`);
      const cards = await res.json();
      if (!cards.length) {
        cardsDiv.innerHTML = '<p>No flashcards found.</p>';
        return;
      }
      cards.forEach(card => {
        const d = document.createElement('div');
        d.className = 'question-card';

        const qEl = document.createElement('p');
        qEl.textContent = `Q: ${card.question}`;
        d.appendChild(qEl);

        const details = document.createElement('div');
        details.style.display = 'none';

        const aEl = document.createElement('div');
        aEl.className = 'answer';
        aEl.textContent = `A: ${card.answer}`;
        details.appendChild(aEl);

        if (card.codeSnippet) {
          const pre = document.createElement('pre');
          pre.className = 'code-snippet';
          pre.textContent = card.codeSnippet;
          details.appendChild(pre);
        }
        d.appendChild(details);

        const btn = document.createElement('button');
        btn.className = 'btn-toggle';
        btn.textContent = 'Show Details';
        btn.onclick = () => {
          const show = details.style.display === 'block';
          details.style.display = show ? 'none' : 'block';
          btn.textContent = show ? 'Show Details' : 'Hide Details';
        };
        d.appendChild(btn);

        cardsDiv.appendChild(d);
      });
    } catch (err) {
      console.error('Error loading flashcards', err);
      cardsDiv.innerHTML = '<p>Error loading flashcards.</p>';
    }
  }
</script>
</body>
</html>
