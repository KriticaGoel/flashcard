<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flash Cards</title>
    <style>
        /* Card container styles */
        #topicFilter {
            margin: 20px auto;
            max-width: 300px;
        }


        #topicSelect {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
        }

        #topicInput {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }


        #studyMode {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100%;
            overflow: hidden;
        }

        .card {
            position: relative;
            width: 90%;
            max-width: 600px;
            height: 60vh;
            perspective: 1500px;
            margin: auto;
            touch-action: pan-x pan-y;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border-radius: 10px;
            cursor: pointer;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .card-back {
            transform: rotateY(180deg);
        }

        /* Responsive text sizing */
        .card h2, .card p {
            font-size: clamp(16px, 4vw, 32px);
            margin: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .card pre {
            font-size: clamp(14px, 3vw, 24px);
            white-space: pre-wrap;
            max-width: 100%;
        }
        /* ... existing styles ... */
        #studyMode, #cardsList {
            display: none;
        }

        .active {
            display: block !important;
        }

        /* Modal base */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        /* Modal content wrapper */
        .modal-content {
            background-color: white;
            margin: 20px auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 40px); /* Account for margin */
        }

        /* Form title */
        #formTitle {
            margin-top: 0;
            margin-bottom: 20px;
        }

        /* Form layout */
        #editForm {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            padding-bottom: 60px; /* Space for buttons */
        }

        /* Form groups */
        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group textarea, 
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        /* Button group */
        .button-group {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background-color: white;
            border-top: 1px solid #eee;
            text-align: right;
            border-radius: 0 0 8px 8px;
        }

        .button-group button {
            padding: 8px 20px;
            margin-left: 10px;
            border-radius: 4px;
            cursor: pointer;
            border: none;
            font-size: 14px;
        }

        .button-group button[type="submit"] {
            background-color: #4CAF50;
            color: white;
        }

        .button-group button[type="button"] {
            background-color: #f44336;
            color: white;
        }

        /* Responsive adjustments */
        @media screen and (max-height: 600px) {
            .modal-content {
                margin: 10px auto;
                max-height: calc(100vh - 20px);
            }
            
            #editForm {
                padding-bottom: 70px;
            }
        }

        /* Fix for very small screens */
        @media screen and (max-width: 400px) {
            .modal-content {
                margin: 10px;
                width: calc(100% - 20px);
            }
            
            .button-group button {
                padding: 8px 15px;
                font-size: 13px;
            }
        }

        .card-list-item {
            border: 1px solid #ddd;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div id="controls" style="text-align: center; margin: 20px;">
    <button onclick="switchToStudyMode()">Study Mode</button>
    <button onclick="showAllCards()">Manage Cards</button>
    <button onclick="showEditForm(null)">Add New Card</button>
</div>

<!-- Study Mode Section -->
<div id="studyMode">
    <div style="text-align: center; margin: 20px;">
        <button onclick="getRandomCard()">Next Card</button>
    </div>
    <div class="card" onclick="flipCard()">
        <div class="card-inner">
            <div class="card-front">
                <h2 id="question"></h2>
            </div>
            <div class="card-back">
                <div>
                    <p id="answer"></p>
                    <pre id="codeSnippet"></pre>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cards List Section -->
<div id="cardsList" class="card-list"></div>

<!-- Edit/Add Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h2 id="formTitle">Edit Flash Card</h2>
        <form id="editForm" onsubmit="handleSubmit(event)">
            <input type="hidden" id="cardId">
            <div class="form-group">
                <label for="questionInput">Question:</label>
                <textarea id="questionInput" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="answerInput">Answer:</label>
                <textarea id="answerInput" rows="3" required></textarea>
            </div>
            <div class="form-group">
                <label for="codeSnippetInput">Code Snippet:</label>
                <textarea id="codeSnippetInput" rows="5"></textarea>
            </div>
            <div class="form-group">
                <label for="topicInput">Topic:</label>
                <input type="text" id="topicInput" required>
            </div>
            <div class="form-group">
                <label for="followUpInput">FollowUp of:</label>
                <input type="text" id="followUpInput" required>
            </div>
            <div class="form-group">
                <label for="categoryInput">Category:</label>
                <input type="text" id="categoryInput" required>
            </div>
            <div class="button-group">
                <button type="button" onclick="closeEditForm()">Cancel</button>
                <button type="submit">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Initialize the app in study mode
    document.addEventListener('DOMContentLoaded', function() {
        switchToStudyMode();
    });

    // Initialize swipe handling for study mode cards
    function initializeSwipeHandling() {
        const card = document.querySelector('.card');
        let touchStartX = 0;
        let touchStartY = 0;
        let initialX = 0;
        let currentX = 0;

        card.addEventListener('touchstart', handleTouchStart);
        card.addEventListener('touchmove', handleTouchMove);
        card.addEventListener('touchend', handleTouchEnd);

        function handleTouchStart(e) {
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            initialX = card.getBoundingClientRect().left;
            
            // Reset any previous transforms
            card.style.transition = 'none';
            card.style.transform = `translateX(0px)`;
        }

        function handleTouchMove(e) {
            if (!touchStartX) return;

            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            
            // Calculate distance moved
            const diffX = touchX - touchStartX;
            const diffY = touchY - touchStartY;

            // If horizontal swipe is more prominent than vertical scroll
            if (Math.abs(diffX) > Math.abs(diffY)) {
                e.preventDefault(); // Prevent scrolling while swiping
                currentX = diffX;
                
                // Add some resistance to the swipe
                const resistance = 0.5;
                card.style.transform = `translateX(${currentX * resistance}px)`;
            }
        }

        function handleTouchEnd(e) {
            if (!touchStartX) return;

            const touchEndX = e.changedTouches[0].clientX;
            const swipeDistance = touchEndX - touchStartX;
            const swipeThreshold = 100; // Minimum distance for a swipe

            card.style.transition = 'transform 0.3s ease-out';

            if (swipeDistance > swipeThreshold) {
                // Swiped right
                card.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    card.style.transform = 'translateX(0)';
                    getRandomCard();
                }, 300);
            } else if (swipeDistance < -swipeThreshold) {
                // Swiped left
                card.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    card.style.transform = 'translateX(0)';
                    getRandomCard();
                }, 300);
            } else {
                // Reset position if swipe wasn't far enough
                card.style.transform = 'translateX(0)';
            }

            // Reset values
            touchStartX = 0;
            currentX = 0;
        }
    }

    // Update the switchToStudyMode function to initialize swipe handling
    function switchToStudyMode() {
        document.getElementById('studyMode').classList.add('active');
        document.getElementById('cardsList').classList.remove('active');
        getRandomCard();
        initializeSwipeHandling(); // Initialize swipe handling
    }

    async function getRandomCard() {
        try {
            const response = await fetch('/api/flashcards/random');
            if (!response.ok) {
                throw new Error('Failed to fetch random card');
            }
            const card = await response.json();
            document.getElementById('question').textContent = card.question;
            document.getElementById('answer').textContent = card.answer;
            document.getElementById('codeSnippet').textContent = card.codeSnippet || '';
            document.querySelector('.card').classList.remove('flipped');
        } catch (error) {
            console.error('Error fetching random card:', error);
            alert('Error loading card. Please try again.');
        }
    }

    function showAllCards() {
        document.getElementById('studyMode').classList.remove('active');
        document.getElementById('cardsList').classList.add('active');
        loadAllCards();
    }

    async function loadAllCards() {
        try {
            const response = await fetch('/api/flashcards');
            const cards = await response.json();
            const cardsList = document.getElementById('cardsList');

            if (cards.length === 0) {
                cardsList.innerHTML = '<p>No cards available. Add some cards to get started!</p>';
                return;
            }

            cardsList.innerHTML = cards.map(card => `
            <div class="card-list-item">
                <h3>Question: ${escapeHtml(card.question)}</h3>
                <p>Answer: ${escapeHtml(card.answer)}</p>
                ${card.codeSnippet ? `<pre>Code: ${escapeHtml(card.codeSnippet)}</pre>` : ''}
                <p>Category: ${escapeHtml(card.category)}</p>
                <p>Topic: ${escapeHtml(card.topic)}</p>
                <div class="button-group">
                    <button onclick="editCard(${card.id})">Edit</button>
                    <button onclick="deleteCard(${card.id})">Delete</button>
                </div>
            </div>
        `).join('');
        } catch (error) {
            console.error('Error loading cards:', error);
            alert('Error loading cards. Please try again.');
        }
    }

    // Add this helper function to escape HTML content
    function escapeHtml(unsafe) {
        if (!unsafe) return '';
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Add this new function to handle edit button clicks
    async function editCard(cardId) {
        try {
            const response = await fetch(`/api/flashcards/${cardId}`);
            if (!response.ok) {
                throw new Error('Failed to fetch card details');
            }
            const card = await response.json();
            showEditForm(card);
        } catch (error) {
            console.error('Error fetching card details:', error);
            alert('Error loading card details. Please try again.');
        }
    }

    // Update the showEditForm function
    function showEditForm(card) {
        document.getElementById('formTitle').textContent = card ? 'Edit Flash Card' : 'Add New Flash Card';
        document.getElementById('cardId').value = card ? card.id : '';
        document.getElementById('questionInput').value = card ? card.question : '';
        document.getElementById('answerInput').value = card ? card.answer : '';
        document.getElementById('codeSnippetInput').value = card ? card.codeSnippet || '' : '';
        document.getElementById('categoryInput').value = card ? card.category : '';
        document.getElementById('topicInput').value = card ? card.topic : '';
       document.getElementById('followUpInput').value = card ? card.followUp :'';
        document.getElementById('editModal').style.display = 'block';
    }




    function closeEditForm() {
        document.getElementById('editModal').style.display = 'none';
        document.getElementById('editForm').reset();
    }

    async function handleSubmit(event) {
        event.preventDefault();
        const cardId = document.getElementById('cardId').value;
        const cardData = {
            question: document.getElementById('questionInput').value,
            answer: document.getElementById('answerInput').value,
            codeSnippet: document.getElementById('codeSnippetInput').value,
            category: document.getElementById('categoryInput').value,
            topic:document.getElementById('topicInput').value,
            followUp: document.getElementById('followUpInput').value
        };

        try {
            const url = cardId ? `/api/flashcards/${cardId}` : '/api/flashcards';
            const method = cardId ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(cardData)
            });

            if (!response.ok) {
                throw new Error('Failed to save card');
            }

            closeEditForm();
            if (document.getElementById('cardsList').classList.contains('active')) {
                loadAllCards();
            } else {
                switchToStudyMode();
            }
        } catch (error) {
            console.error('Error:', error);
            alert('Error saving card. Please try again.');
        }
    }

    async function deleteCard(id) {
        if (!confirm('Are you sure you want to delete this card?')) {
            return;
        }

        try {
            const response = await fetch(`/api/flashcards/${id}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                throw new Error('Failed to delete card');
            }

            loadAllCards();
        } catch (error) {
            console.error('Error:', error);
            alert('Error deleting card. Please try again.');
        }
    }

    function flipCard() {
        document.querySelector('.card').classList.toggle('flipped');
    }

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target === document.getElementById('editModal')) {
            closeEditForm();
        }
    }
</script>
</body>
</html>